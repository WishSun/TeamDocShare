# 处理客户端请求流程  
---
![](https://i.imgur.com/BFUo6gp.png)    


## 注解:  
1. **epoll监听到客户端请求数据到来**  
     
2. **读取一个客户端请求协议包**  
   服务器端和客户端会有一个公共约定的协议类，客户端向服务端发送任何请求，都需要构建这么一个请求协议包，然后服务端根据协议规则去解析这个协议包，所以每次客户端的数据到来时，服务端都要首先接收一个协议包。  

3. **将该请求协议包制作成一个任务对象，然后判断是大任务还是小任务**  
   将协议包作为初始化参数创建一个任务对象，然后根据协议包中的类型字段，来判断本次请求是什么类型的请求，如果是非文件传输类的请求，比如登录、注册等等都认为是小任务; 如果是文件传输类请求，即上传文件或下载文件，则需要判断文件的大小，如果文件大于50MB，则认为是大任务，然后转步骤5，否则即是小任务，转步骤4。  

4. **由小任务线程池将其添加到小任务线程的任务链表**   
   将任务对象使用小任务线程池的append方法添加到合适的工作线程的任务链表中。这里添加时，会选择当前线程池中负载最轻的工作线程，使用的是堆算法，堆出空闲任务结点数最多的工作线程，然后由该线程来执行任务。  

5. **由大任务线程池将其添加到大任务线程的任务链表**    
   和小任务线程池工作模式类似。  

6. **线程池工作线程解析任务类型**  
	- **6.1 用户注册任务**  
		- 解析出是注册任务，则再从套接字接收用户注册信息数据
		- 接收到用户注册信息后，调用用户管理类中的注册用户模块，获取其操作结果 
			- 如果插入成功，则向客户端发送正确请求响应包，表示注册成功。  
			- 如果插入失败，填充错误信息，返回错误响应包，表示注册失败。  
		
	- **6.2 用户登录任务**  
		- 解析出是登录任务，则再从套接字接收用户登录信息数据
		- 接收到用户登录信息后，调用用户管理类中的查找用户模块，获取其操作结果
			- 如果查找到了，则向客户端发送正确请求响应包，表示登录成功。
			- 如果没有查找到，填充错误信息，返回错误响应包，表示登录失败。
		
	- **6.3 上传文件任务**  
		- 首先解析出协议包中的文件md5值。 然后调用用户管理类中查找md5值与文件路径映射模块，查找该md5值所对应的文件路径 
			- 如果查找到记录，即md5码所对应的文件路径，则在该用户的共享目录下创建该文件硬链接，然后向客户端发送正确请求响应包，这个包里的请求字节数设置为0， 表示已上传完毕，这就是秒传的实现。
			- 如果没有找到该md5码的记录，则给客户端发送一个正确请求响应包，不过这个包里的请求字节是文件的大小，即让客户端发送文件数据。
		- 不断接收用户的文件数据，并写入到文件描述符中
			- 如果接收到用户的完整文件数据。
				- <1>. 调用用户管理类中设置md5值与文件路径映射模块，将该文件的md5值，以及该文件的路径构成一条记录存入文件md5映射数据库表
				- <2>. 调用用户管理类中的设置用户与文件路径映射模块，将该用户的用户名，以及改文件的路径构成一条记录存入用户文件映射表
				- <3>. 关闭该文件描述符，并将该任务结点从任务链表中删除。  
			- 如果接收数据出错，可能客户端关闭了连接，则删除该文件。 将该任务结点从任务链表中删除。  
		
	- **6.4 下载文件任务**  
		- 首先解析出协议包中请求的文件路径，查看请求的文件是否存在。
			- 如果存在则打开文件，向客户端返回正确请求响应，协议包内请求字节数为文件大小，指示客户端开始接收文件数据。
			- 如果文件不存在，则填充错误信息，向客户端返回错误响应包。 
		- 打开文件，不断从文件中读取数据，发送给客户端套接字描述符。
			- 如果写入过程中出错，则关闭文件描述符，并将该任务结点从任务链表中删除。
			- 如果将所有文件数据都发送完毕，则关闭文件描述符，并将任务结点从任务链表中删除。
			
	- **6.5 获取所有群组列表**  
	 	- 调用群组管理类中查找所有群组信息模块，获取到群组信息的数目和大小，然后构建协议包，发送给客户端，指示客户端接收群组信息，然后将获取到的群组信息发送给客户端。  
	 	
	- **6.6 用户更改群组任务**  
		- 首先解析出协议包中其所更改的组ID，然后调用用户管理类中修改群组模块，获取操作结果
			- 如果操作失败，即该群组不存在，则填充错误信息，向客户端返回错误响应包。
			- 如果操作成功，再构造修改用户组ID的sql语句并执行，执行完毕后，向客户端回复成功响应包。  
		
	- **6.7 用户创建群组任务**  
	    - 再从客户端套接字描述符中接收一个群组类大小的数据块，即接收客户端发送的新群组信息，然后调用群组管理类中插入新群组模块，获取操作结果  
	    	- 如果插入失败，则填充错误信息，向客户端返回错误响应包。
	    	- 如果插入成功，则向客户端返回成功响应包。
	    	
	- **6.8 用户获取文件列表任务**  
		- 首先在协议包中获取该用户的群组ID，然后调用用户管理类中获取文件列表模块，然后根据获取结果构建协议包发送给客户端，指示客户端开始接收文件列表数据，然后将文件列表数据发送给客户端。
